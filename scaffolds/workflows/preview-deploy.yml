# ============================================================================
# PREVIEW DEPLOY WORKFLOW
# ============================================================================
#
# Automatically deploys preview sites when pull requests are opened or updated.
# Each PR gets its own subdomain: pr-{number}-{title}.{ROOT_DOMAIN}
#
# ============================================================================
# PREREQUISITES - Complete these steps BEFORE using this workflow
# ============================================================================
#
# This workflow deploys preview sites to an existing server. You must provision
# and configure a preview server first using DeployerPHP.
#
# STEP 1: Provision a Preview Server
# -----------------------------------
# Choose ONE of the following methods:
#
# Option A: Add an existing server
#   deployer server:add \
#     --name=preview \
#     --host=YOUR_SERVER_IP \
#     --username=root \
#     --private-key-path=~/.ssh/id_rsa
#
# Option B: Provision a new AWS EC2 instance
#   deployer pro:aws:provision \
#     --name=preview \
#     --instance-type=t3.small \
#     --key-pair=YOUR_KEY_PAIR \
#     --vpc=YOUR_VPC_ID \
#     --subnet=YOUR_SUBNET_ID \
#     --private-key-path=~/.ssh/id_rsa
#
# Option C: Provision a new DigitalOcean droplet
#   deployer pro:do:provision \
#     --name=preview \
#     --size=s-1vcpu-2gb \
#     --region=nyc1 \
#     --private-key-path=~/.ssh/id_rsa
#
# STEP 2: Install Server Software
# --------------------------------
#   deployer server:install \
#     --server=preview \
#     --php-version=8.3 \
#     --extensions=bcmath,curl,gd,intl,mbstring,mysql,redis,xml,zip \
#     --generate-deploy-key
#
# STEP 3: Add Deploy Key to Git Provider
# ---------------------------------------
# The server:install command outputs a public key. Add this as a deploy key
# to your GitHub/GitLab/Bitbucket repository with read access.
#
# STEP 4: Configure DNS
# ---------------------
# Point your preview domain (e.g., previews.example.com) to the server IP.
# This workflow creates per-PR subdomains (e.g., pr-123-feature.previews.example.com).
#
# STEP 5: Create GitHub Secrets
# -----------------------------
# Export your inventory and create the required secrets:
#
#   # Export inventory as base64
#   cat ~/.deployer/inventory.json | base64
#
# Add these secrets to your GitHub repository:
#   - DEPLOYER_SSH_KEY: Contents of ~/.ssh/id_rsa (the private key)
#   - DEPLOYER_INVENTORY: Base64-encoded inventory from above
#   - APP_ENV_CONTENT: Full .env file contents for preview environments
#   - DNS provider secrets (see DNS section below)
#
# ============================================================================
# REQUIRED GITHUB SECRETS
# ============================================================================
#
# For all configurations:
#   DEPLOYER_SSH_KEY        - SSH private key for server access
#   DEPLOYER_INVENTORY      - Base64-encoded inventory JSON
#   APP_ENV_CONTENT         - Full .env file contents for the application
#
# For AWS Route53 DNS:
#   AWS_ACCESS_KEY_ID       - AWS access key with Route53 permissions
#   AWS_SECRET_ACCESS_KEY   - AWS secret key
#   AWS_ROUTE53_ZONE_ID     - Hosted zone ID for your preview domain
#
# For DigitalOcean DNS:
#   DIGITALOCEAN_TOKEN      - DigitalOcean API token with DNS permissions
#
# For Cloudflare DNS:
#   CLOUDFLARE_API_TOKEN    - Cloudflare API token with DNS edit permissions
#   CLOUDFLARE_ZONE_ID      - Zone ID for your preview domain
#
# ============================================================================

name: Preview Deploy

on:
  pull_request:
    types: [opened, reopened, synchronize]

# Cancel any in-progress deployment when a new commit is pushed
concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  # ==========================================================================
  # CONFIGURATION - Edit these values for your project
  # ==========================================================================
  ROOT_DOMAIN: "previews.example.com"   # Your preview domain (PR subdomains created under this)
  SERVER_NAME: "preview"                 # Server name from your inventory
  PHP_VERSION: "8.3"                     # PHP version for the site
  WEB_ROOT: "public"                     # Public directory relative to project root
  KEEP_RELEASES: "3"                     # Number of old releases to keep

jobs:
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      subdomain: ${{ steps.subdomain.outputs.subdomain }}
      fqdn: ${{ steps.subdomain.outputs.fqdn }}
      server_ip: ${{ steps.server.outputs.ip }}
      server_name: ${{ steps.server.outputs.name }}

    steps:
      # ========================================================================
      # SETUP
      # ========================================================================

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, curl, zip
          coverage: none

      - name: Install DeployerPHP
        run: composer global require deployer-php/deployer-php

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOYER_SSH_KEY }}" > ~/.ssh/deployer
          chmod 600 ~/.ssh/deployer
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts

      - name: Restore inventory
        run: |
          mkdir -p ~/.deployer
          echo "${{ secrets.DEPLOYER_INVENTORY }}" | base64 -d > ~/.deployer/inventory.json

      - name: Generate subdomain
        id: subdomain
        run: |
          # Sanitize PR title for DNS-safe subdomain
          TITLE="${{ github.event.pull_request.title }}"
          SANITIZED=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | \
            sed 's/[^a-z0-9-]/-/g' | \
            sed 's/--*/-/g' | \
            sed 's/^-//' | \
            sed 's/-$//' | \
            cut -c1-30)
          SUBDOMAIN="pr-${{ github.event.pull_request.number }}-${SANITIZED}"
          FQDN="${SUBDOMAIN}.${{ env.ROOT_DOMAIN }}"

          echo "subdomain=${SUBDOMAIN}" >> $GITHUB_OUTPUT
          echo "fqdn=${FQDN}" >> $GITHUB_OUTPUT
          echo "Preview will be deployed to: https://${FQDN}"

      - name: Post initial status
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Preview Deployment

            | Status | Details |
            |--------|---------|
            | :hourglass: | Deployment in progress... |

            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`
            **Domain:** \`${{ steps.subdomain.outputs.fqdn }}\``;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ========================================================================
      # SERVER LOOKUP
      # ========================================================================

      - name: Get server info
        id: server
        run: |
          SERVER_IP=$(deployer server:info --server="${{ env.SERVER_NAME }}" --json | jq -r '.host')
          echo "name=${{ env.SERVER_NAME }}" >> $GITHUB_OUTPUT
          echo "ip=${SERVER_IP}" >> $GITHUB_OUTPUT
          echo "Using server: ${{ env.SERVER_NAME }} (${SERVER_IP})"

      # ========================================================================
      # DNS RECORD - Uncomment ONE provider below
      # ========================================================================

      # ------------------------------------------------------------------------
      # OPTION A: AWS Route53
      # ------------------------------------------------------------------------
      # Required secrets: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_ROUTE53_ZONE_ID
      #
      # - name: Set DNS record (Route53)
      #   env:
      #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     AWS_DEFAULT_REGION: us-east-1
      #   run: |
      #     deployer pro:aws:dns:set \
      #       --zone="${{ secrets.AWS_ROUTE53_ZONE_ID }}" \
      #       --type=A \
      #       --name="${{ steps.subdomain.outputs.subdomain }}" \
      #       --value="${{ steps.server.outputs.ip }}" \
      #       --ttl=300

      # ------------------------------------------------------------------------
      # OPTION B: DigitalOcean DNS
      # ------------------------------------------------------------------------
      # Required secrets: DIGITALOCEAN_TOKEN
      #
      # - name: Set DNS record (DigitalOcean)
      #   env:
      #     DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
      #   run: |
      #     deployer pro:do:dns:set \
      #       --zone="${{ env.ROOT_DOMAIN }}" \
      #       --type=A \
      #       --name="${{ steps.subdomain.outputs.subdomain }}" \
      #       --value="${{ steps.server.outputs.ip }}" \
      #       --ttl=300

      # ------------------------------------------------------------------------
      # OPTION C: Cloudflare
      # ------------------------------------------------------------------------
      # Required secrets: CLOUDFLARE_API_TOKEN, CLOUDFLARE_ZONE_ID
      #
      # - name: Set DNS record (Cloudflare)
      #   env:
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #   run: |
      #     deployer pro:cf:dns:set \
      #       --zone="${{ secrets.CLOUDFLARE_ZONE_ID }}" \
      #       --type=A \
      #       --name="${{ steps.subdomain.outputs.subdomain }}" \
      #       --value="${{ steps.server.outputs.ip }}" \
      #       --ttl=1 \
      #       --no-proxied

      # ========================================================================
      # SITE DEPLOYMENT
      # ========================================================================

      - name: Wait for DNS propagation
        run: |
          echo "Waiting 30 seconds for DNS propagation..."
          sleep 30

      - name: Create site
        run: |
          # Check if site already exists (redeployment)
          if deployer site:info --domain="${{ steps.subdomain.outputs.fqdn }}" &>/dev/null; then
            echo "Site already exists, skipping creation..."
          else
            deployer site:create \
              --domain="${{ steps.subdomain.outputs.fqdn }}" \
              --server="${{ steps.server.outputs.name }}" \
              --php-version="${{ env.PHP_VERSION }}" \
              --www-mode=redirect-to-root \
              --web-root="${{ env.WEB_ROOT }}"
          fi

      - name: Write .env from secrets
        run: |
          FQDN="${{ steps.subdomain.outputs.fqdn }}"

          # Write secret to local temp file (no shell interpretation)
          cat > /tmp/.env.preview << 'ENVEOF'
          ${{ secrets.APP_ENV_CONTENT }}
          ENVEOF

          # Upload via SFTP (binary-safe, no quoting issues)
          deployer site:shared:push \
            --domain="${FQDN}" \
            --local=/tmp/.env.preview \
            --remote=.env \
            --yes

          # Clean up local temp file
          rm -f /tmp/.env.preview

      - name: Deploy application
        run: |
          deployer site:deploy \
            --domain="${{ steps.subdomain.outputs.fqdn }}" \
            --repo="${{ github.event.repository.ssh_url }}" \
            --branch="${{ github.head_ref }}" \
            --keep-releases="${{ env.KEEP_RELEASES }}" \
            --yes

      - name: Enable HTTPS
        run: |
          # Skip if already has HTTPS
          if deployer site:info --domain="${{ steps.subdomain.outputs.fqdn }}" --json | jq -e '.https' &>/dev/null; then
            echo "HTTPS already enabled, skipping..."
          else
            deployer site:https \
              --domain="${{ steps.subdomain.outputs.fqdn }}" \
              --yes
          fi

      # ========================================================================
      # STATUS UPDATE
      # ========================================================================

      - name: Post success status
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Preview Deployment

            | Status | URL |
            |--------|-----|
            | :white_check_mark: Deployed | https://${{ steps.subdomain.outputs.fqdn }} |

            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\`
            **Server:** \`${{ steps.server.outputs.name }}\` (\`${{ steps.server.outputs.ip }}\`)

            ---
            _Preview will be automatically cleaned up when this PR is closed._`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            }

      - name: Post failure status
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Preview Deployment

            | Status | Details |
            |--------|---------|
            | :x: Failed | See [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            **Branch:** \`${{ github.head_ref }}\`
            **Commit:** \`${{ github.sha }}\``;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('## Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            }
